// From https://github.com/gohyperr/hyperr-ecs

!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["hyperr-ecs"]=e():t.HyperrECS=e()}(this,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=2)}([function(t,e,n){"use strict";n.r(e),function(t){n.d(e,"Boolean",(function(){return i})),n.d(e,"Number",(function(){return r})),n.d(e,"Text",(function(){return o})),n.d(e,"JSON",(function(){return a}));var i={name:"Boolean",initial:function(t){return t||!1},toJSON:function(t){return t},fromJSON:function(t,e){return t||!1}},r={name:"Number",initial:function(t){return t||0},toJSON:function(t){return t},fromJSON:function(t,e){return t||0}},o={name:"Text",initial:function(t){return t||""},toJSON:function(t){return t},fromJSON:function(t,e){return t||""}},s="undefined"==typeof window?t.JSON:window.JSON,a={name:"JSON",initial:function(t){return t?s.parse(s.stringify(t)):null},toJSON:function(t){return t&&s.stringify(t)},fromJSON:function(t,e){return t&&s.parse(t)}}}.call(this,n(1))},function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){"use strict";n.r(e),n.d(e,"World",(function(){return P})),n.d(e,"System",(function(){return J})),n.d(e,"Component",(function(){return d})),n.d(e,"LocalComponent",(function(){return F})),n.d(e,"StateComponent",(function(){return C})),n.d(e,"Not",(function(){return U})),n.d(e,"Modified",(function(){return L})),n.d(e,"Types",(function(){return i}));var i=n(0);function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var o=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.Systems=new Map,this.systems=[],this.systemsByName={},this.tick=0}var e,n,i;return e=t,(n=[{key:"register",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.Systems.has(t)){var n=new t(this.world,e);this.Systems.set(t,n);for(var i=0,r=0;r<this.systems.length;r++){var o=this.systems[r];if(o.order>n.order)break;i=r}return this.systems.splice(i+1,0,n),this.systemsByName[t.name]=n,n.init(),this}console.warn("ECS: system already registered")}},{key:"get",value:function(t){return this.Systems.get(t)}},{key:"getByName",value:function(t){return this.systemsByName[t]}},{key:"update",value:function(t){for(var e=0;e<this.systems.length;e++){this.tick++;var n=this.systems[e];n.active&&n.update(t)}}},{key:"reset",value:function(){this.systems.forEach((function(t){t.reset()}))}}])&&r(e.prototype,n),i&&r(e,i),t}();function s(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var a=function(){function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.Components=n,this.Modified=[],this.archetypes=[];for(var i=0;i<n.length;i++){var r=n[i];r.isModified&&this.Modified.push(r.Component)}for(var o in this.world.archetypes.archetypes){var s=this.world.archetypes.archetypes[o];this.matchesArchetype(s)&&this.archetypes.push(s)}}var e,n,i;return e=t,(n=[{key:"isModified",value:function(t){for(var e=0;e<this.Modified.length;e++){var n=this.Modified[e];if(t.get(n).modifiedUntilSystemTick>=this.world.systems.tick)return!0}return!1}},{key:"forEach",value:function(t){this.Modified.length?this._forEachModified(t):this._forEach(t)}},{key:"_forEachModified",value:function(t){for(var e=this.archetypes.length-1;e>=0;--e)for(var n=this.archetypes[e].entities,i=n.length-1;i>=0;--i){var r=n[i];this.isModified(r)&&t(r)}}},{key:"_forEach",value:function(t){for(var e=this.archetypes.length-1;e>=0;--e)for(var n=this.archetypes[e].entities,i=n.length-1;i>=0;--i)t(n[i])}},{key:"count",value:function(){var t=0;return this.forEach((function(){return function(t){throw new Error('"'+t+'" is read-only')}("count"),t++})),t}},{key:"onArchetypeCreated",value:function(t){this.matchesArchetype(t)&&this.archetypes.push(t)}},{key:"matchesArchetype",value:function(t){for(var e=!0,n=0;n<this.Components.length;n++){var i=this.Components[n],r=i.isNot,o=i.isModified;if((r||o)&&(i=i.Component),r){if(-1!==t.Components.indexOf(i)){e=!1;break}}else if(-1===t.Components.indexOf(i)){e=!1;break}}e&&this.archetypes.push(t)}}])&&s(e.prototype,n),i&&s(e,i),t}();function c(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var u=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.queries=[]}var e,n,i;return e=t,(n=[{key:"create",value:function(t){var e=new a(this.world,t);return this.queries.push(e),e}},{key:"onArchetypeCreated",value:function(t){for(var e=0;e<this.queries.length;e++)this.queries[e].onArchetypeCreated(t)}}])&&c(e.prototype,n),i&&c(e,i),t}();var f=function t(e,n,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.id=n,this.Components=i,this.entities=[]};function h(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var l=function(){function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.archetypes={},this.initialId=this.createInitialId(n),this.createArchetype(this.initialId,[])}var e,n,i;return e=t,(n=[{key:"createInitialId",value:function(t){for(var e="";t;)e+="0",t--;return e}},{key:"onEntityActive",value:function(t){this.addToArchetype(t)}},{key:"onEntityComponentChange",value:function(t,e,n){t.active&&this.removeFromArchetype(t),t.archetypeId=t.archetypeId.substring(0,e.id)+(n?"1":"0")+t.archetypeId.substring(e.id+1),this.archetypes[t.archetypeId]||this.createArchetype(t.archetypeId,t.Components),t.active&&this.addToArchetype(t)}},{key:"onEntityInactive",value:function(t){this.removeFromArchetype(t)}},{key:"addToArchetype",value:function(t){var e=this.archetypes[t.archetypeId];-1===e.entities.indexOf(t)&&e.entities.push(t)}},{key:"removeFromArchetype",value:function(t){var e=this.archetypes[t.archetypeId].entities,n=e.indexOf(t);-1!==n&&e.splice(n,1)}},{key:"createArchetype",value:function(t,e){e=e.slice();var n=new f(this.world,t,e);return this.archetypes[n.id]=n,this.world.queries.onArchetypeCreated(n),n}}])&&h(e.prototype,n),i&&h(e,i),t}();function y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function p(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var d=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var i in y(this,t),this.world=e,this.name=this.constructor.name,this.props=[],this.modifiedUntilSystemTick=0,this.constructor.props){var r=this.constructor.props[i],o=n[i];r.type||(r={type:r},this.constructor.props[i]=r),this[i]=r.type.initial(void 0===o?r.default:o),this.props.push(r)}}var e,n,i;return e=t,(n=[{key:"toJSON",value:function(){var t={};for(var e in this.constructor.props){var n=this.constructor.props[e],i=n.type||n;t[e]=i.toJSON(this[e])}return t}},{key:"fromJSON",value:function(t){for(var e in this.constructor.props){var n=this.constructor.props[e],i=n.type||n;void 0!==t[e]&&(this[e]=i.fromJSON(t[e],this[e]))}return this}},{key:"modified",value:function(){this.modifiedUntilSystemTick=this.world.systems.tick+this.world.systems.systems.length}}])&&p(e.prototype,n),i&&p(e,i),t}();function v(t){return(v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function m(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function w(t,e){return(w=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function b(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=k(t);if(e){var r=k(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return g(this,n)}}function g(t,e){return!e||"object"!==v(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function k(t){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}d.props={},d.isComponent=!0;var C=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&w(t,e)}(n,t);var e=b(n);function n(){return m(this,n),e.apply(this,arguments)}return n}(d);function O(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}C.isStateComponent=!0;var E=function(){function t(e,n,i,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.id=i,this.name=n||null,this.meta=r||{},this.Components=[],this.components=new Map,this.inactiveComponents=[],this.archetypeId=e.archetypes.initialId,this.active=!1}var e,n,i;return e=t,(n=[{key:"add",value:function(t,e,n){var i;t.isComponent?i=new t(this.world,e):(i=t,t=t.constructor);var r=this.components.has(t);return this.components.set(t,i),r||(this.Components.push(t),this.world.archetypes.onEntityComponentChange(this,t,!0)),n?i:this}},{key:"get",value:function(t){return this.components.get(t)}},{key:"has",value:function(t){return!!this.components.get(t)}},{key:"remove",value:function(t){if(this.components.has(t)){this.components.delete(t);var e=this.Components.indexOf(t);return this.Components.splice(e,1),this.world.archetypes.onEntityComponentChange(this,t,!1),this.Components.length||!this.deactivating&&!this.destroying||(this.active=!1,this.deactivating=!1,this.destroying=!1,this.world.entities.onEntityInactive(this),this.world.archetypes.onEntityInactive(this)),this}console.warn("Entity: cannot remove component as it doesnt have one")}},{key:"activate",value:function(){if(!this.active){for(;this.inactiveComponents.length;){var t=this.inactiveComponents.pop(),e=t.constructor;this.components.set(e,t),this.Components.push(e),this.world.archetypes.onEntityComponentChange(this,e,!0)}return this.active=!0,this.deactivating=!1,this.destroying=!1,this.world.entities.onEntityActive(this),this.world.archetypes.onEntityActive(this),this}console.warn("Entity: cannot activate as entity is already active")}},{key:"deactivate",value:function(){for(var t=this.Components.length-1;t>=0;--t){var e=this.Components[t];if(e.__proto__===C)this.deactivating=!0;else{var n=this.components.get(e);this.components.delete(e),this.Components.splice(t,1),this.inactiveComponents.push(n),this.world.archetypes.onEntityComponentChange(this,e,!1)}}return this.deactivating||(this.active=!1,this.world.entities.onEntityInactive(this),this.world.archetypes.onEntityInactive(this)),this}},{key:"destroy",value:function(){for(var t=this.Components.length-1;t>=0;--t){var e=this.Components[t];e.__proto__===C?this.destroying=!0:(this.components.delete(e),this.Components.splice(t,1),this.world.archetypes.onEntityComponentChange(this,e,!1))}return this.destroying||(this.active=!1,this.world.entities.onEntityInactive(this),this.world.archetypes.onEntityInactive(this)),this}},{key:"toJSON",value:function(){var t={id:this.id,name:this.name,meta:this.meta};return this.components.forEach((function(e){e.constructor.__proto__===d&&(t[e.name]=e.toJSON())})),t}},{key:"fromJSON",value:function(t){for(var e in this.id=t.id,this.name=t.name,this.meta=t.meta,t)if("id"!==e&&"name"!==e&&"meta"!==e){var n=this.world.components.getByName(e);this.add(n,void 0,!0).fromJSON(t[e])}return this}}])&&O(e.prototype,n),i&&O(e,i),t}();function S(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var N=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.entities=new Map,this.nextEntityId=0}var e,n,i;return e=t,(n=[{key:"create",value:function(t,e){return e||(e="".concat(this.world.id,":").concat(this.nextEntityId++)),new E(this.world,t,e)}},{key:"getById",value:function(t){return this.entities.get(t)}},{key:"onEntityActive",value:function(t){this.entities.set(t.id,t)}},{key:"onEntityInactive",value:function(t){this.entities.delete(t.id)}},{key:"reset",value:function(){this.entities.forEach((function(t){t.destroy()}))}}])&&S(e.prototype,n),i&&S(e,i),t}();function _(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var j=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.lastComponentId=0,this.componentsByName={}}var e,n,i;return e=t,(n=[{key:"register",value:function(t){var e=this;return Array.isArray(t)||(t=[t]),t.forEach((function(t){t.id=e.lastComponentId++,e.componentsByName[t.name]=t})),this}},{key:"getByName",value:function(t){return this.componentsByName[t]}}])&&_(e.prototype,n),i&&_(e,i),t}();function I(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function x(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var P=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.idSize,i=void 0===n?64:n;I(this,t),this.id=0,this.version=0,this.systems=new o(this),this.queries=new u(this),this.archetypes=new l(this,i),this.entities=new N(this),this.components=new j(this)}var e,n,i;return e=t,(n=[{key:"addPlugin",value:function(t){return t(this),this}},{key:"update",value:function(t){this.version++,this.systems.update(t)}},{key:"reset",value:function(){this.entities.reset(),this.update(),this.systems.reset()}},{key:"toJSON",value:function(){var t={nextEntityId:this.entities.nextEntityId,entities:[]};return this.entities.entities.forEach((function(e){return t.entities.push(e.toJSON())})),t}},{key:"fromJSON",value:function(t){var e=this;this.entities.nextEntityId=t.nextEntityId,t.entities.forEach((function(t){e.entities.create(t.name,t.id).fromJSON(t).activate()}))}}])&&x(e.prototype,n),i&&x(e,i),t}();function T(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var J=function(){function t(e,n){for(var i in function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.world=e,this.order=n,this.queries={},this.active=!0,this.constructor.queries){var r=this.constructor.queries[i];this.queries[i]=this.world.queries.create(r)}}var e,n,i;return e=t,(n=[{key:"init",value:function(){}},{key:"update",value:function(){}},{key:"reset",value:function(){}}])&&T(e.prototype,n),i&&T(e,i),t}();function A(t){return(A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function M(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function B(t,e){return(B=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function R(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=D(t);if(e){var r=D(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return q(this,n)}}function q(t,e){return!e||"object"!==A(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function D(t){return(D=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var F=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&B(t,e)}(n,t);var e=R(n);function n(){return M(this,n),e.apply(this,arguments)}return n}(d);function U(t){return{Component:t,isNot:!0}}function L(t){return{Component:t,isModified:!0}}F.isLocalComponent=!0}])}));