<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="./ecsy-v0.4.0.js"></script>
    <script src="./ecsy-benchmarks.js"></script>
    <script src="./main.js"></script>
  </head>
  <body>
    <script>
      const getPerformance =
        typeof performance !== "undefined"
          ? typeof performance.memory !== "undefined"
            ? function () {
                return {
                  now: performance.now(),
                  usedHeapSize: performance.memory.usedJSHeapSize,
                  totalHeapSize: performance.memory.totalJSHeapSize,
                };
              }
            : function () {
                return {
                  now: performance.now(),
                  usedHeapSize: 0,
                  totalHeapSize: 0,
                };
              }
          : function () {
              return {
                now: Date.now(),
                usedHeapSize: 0,
                totalHeapSize: 0,
              };
            };

      const app = Elm.Main.init();

      app.ports.runBenchmark.subscribe(function (benchmark) {
        const samples = [];
        for (let index = 0; index < benchmark.updateCount; ++index) {
          samples.push({
            index: index,
            dt: 0,
            usedHeapSize: 0,
            totalHeapSize: 0,
          });
        }

        const api = getApi(app, benchmark);

        if (!api) {
          app.ports.benchmarkFailed.send("Benchmark not available");
          return;
        }

        api.init();

        setTimeout(function () {
          switch (benchmark.updateType) {
            case "LoopUpdate":
              runBenchmarkLoop(api, benchmark, samples);
              break;
            case "TimerUpdate":
              runBenchmarkTimer(api, benchmark, samples);
              break;
            case "AnimationFrameUpdate":
              runBenchmarkTimer(api, benchmark, samples);
              break;
          }
        }, 100);
      });

      function getApi(app, benchmark) {
        if (benchmark.framework === "JsEcsy") {
          const init = ECSY_BENCHMARKS["init" + benchmark.type];
          if (typeof init === "function") {
            let world;
            return {
              init: function () {
                world = init(benchmark);
                app.ports.initBenchmark.send(null);
              },
              update: function () {
                ECSY_BENCHMARKS.update(world);
              },
            };
          }
        }

        if (benchmark.framework.startsWith("Elm")) {
          return {
            init: function () {
              app.ports.initBenchmark.send(null);
            },
            update: function () {
              app.ports.updateBenchmark.send(null);
            },
          };
        }

        return null;
      }

      function runBenchmarkLoop(api, benchmark, samples) {
        for (let index = 0; index < benchmark.updateCount; ++index) {
          const start = getPerformance();
          api.update();
          const end = getPerformance();

          samples[index] = {
            index: index,
            dt: end.now - start.now,
            usedHeapSize: end.usedHeapSize,
            totalHeapSize: end.totalHeapSize,
          };
        }

        app.ports.benchmarkEnded.send({
          benchmark: benchmark,
          samples: samples,
        });
      }

      function runBenchmarkTimer(api, benchmark, samples) {
        let index = 0;

        const update = function () {
          if (index >= benchmark.updateCount) {
            app.ports.benchmarkEnded.send({
              benchmark: benchmark,
              samples: samples,
            });
            return;
          }

          const start = getPerformance();
          api.update();
          const end = getPerformance();

          samples[index] = {
            index: index,
            dt: end.now - start.now,
            usedHeapSize: end.usedHeapSize,
            totalHeapSize: end.totalHeapSize,
          };

          ++index;

          switch (benchmark.updateType) {
            case "TimerUpdate":
              setTimeout(update);
              break;
            case "AnimationFrameUpdate":
              requestAnimationFrame(update);
              break;
          }
        };

        update();
      }
    </script>
  </body>
</html>
